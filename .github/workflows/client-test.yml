name: 'üß™ Test Cloud Client'

on:
  push:
    branches:    
      - 'main'
    paths:
      - '*.py'
      - '.github/workflows/*.yml'
      - '.github/workflows/*.json'
      - '!**/README.md'

  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize
    branches:    
      - 'main'
    paths:
      - '*.py'
      - '.github/workflows/*.yml'
      - '.github/workflows/*.json'
      - '!**/README.md'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: '‚è≥ Checkout repository'
      uses: actions/checkout@v3
      
    - name: 'üêç Set up Python'
      uses: actions/setup-python@v4
      with:
        cache: 'pip'
        python-version: "3.10"

    - name: 'üõ† Install dependencies'
      run: |
        python -m pip install --upgrade pip
        python -m pip install build==0.10.0 cbor2==5.4.6 M2Crypto==0.38.0 micropython-senml==0.1.0
        sudo apt-get install softhsm2 gnutls-bin libengine-pkcs11-openssl

    - name: 'üì¶ Build package'
      run: python3 -m build

    - name: 'üõ† Install package'
      run: |
        python3 -m build
        pip install dist/arduino_iot_cloud-*.whl

    - name: 'üîë Configure soft crypto device'
      env:
        KEY_PEM: ${{ secrets.KEY_PEM }}
        CERT_PEM: ${{ secrets.CERT_PEM }}
        CA_PEM: ${{ secrets.CA_PEM }}
      run: |
        source tests/ci.sh && ci_configure_softhsm

    - name: '‚òÅÔ∏è  Connect to IoT cloud (basic auth)'
      env:
        DEVICE_ID: ${{ secrets.DEVICE_ID1 }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
      run: |
        python tests/ci.py

    - name: '‚òÅÔ∏è  Connect to IoT cloud (using crypto device)'
      env:
        DEVICE_ID: ${{ secrets.DEVICE_ID2 }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
      run: |
        export SOFTHSM2_CONF="${HOME}/softhsm/tokens/softhsm2.conf"
        python tests/ci.py --crypto-device
